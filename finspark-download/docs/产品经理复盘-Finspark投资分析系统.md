# Finspark 投资分析系统 - 产品复盘报告（v2.1）

> 文档版本: v2.1  
> 复盘日期: 2026年1月  
> 产品定位: 为普通投资者降低财报分析门槛的智能助手

---

## 重要修订摘要（与代码对齐）

本次在 v2.0 基础上完成以下关键修订，已全部与当前代码实现逐条核对：

- 新增“行业对比”能力为独立模块（独立 API 与前端面板），不再作为核心流水线 Agent 之一
- 新增并落地“估值评估 Agent”“趋势解读 Agent”，但在前端执行进度中不单列为卡片（属于结果增强模块）
- 核心分析流水线以“10个前台 Agent”为主，数据采集/清洗与报告生成（PDF/漫画）定位为服务层/输出层
- 模型策略校准：
  - 财报分析主模型使用 GPT-4.1（VectorEngine 统一封装）
  - 漫画图片与脚本生成使用 Gemini 系列（gemini-3-pro-image-preview、gemini-3-pro-preview/2.5-flash）
- 数据来源与缓存策略明确：主数据源 Tushare（含 5000 积分中转站），本地 D1 + KV 作为持久化与缓存
- 新增“智能问数助手（Text-to-SQL）”作为独立模块/Agent（与主编排解耦），面向随时问数场景，产出“表格事实+AI解读”，支持 CSV 导出与 SQL 复制

修订依据：
- 代码位置：
  - 分析编排器 src/agents/orchestrator.ts（新增估值评估/趋势解读、执行顺序与进度回调）
  - 提示词与行业特征 src/agents/prompts.ts（包含 INDUSTRY_COMPARISON、TREND_INTERPRETATION 等）
  - 行业对比 API src/routes/api.ts（/api/stock/industry-* 与 /api/analyze/industry-comparison/:code）
  - 前端行业对比面板 src/index.tsx（industryComparisonCard 区域）
  - 模型封装 src/services/vectorengine.ts（GPT-4.1、Gemini 绑定）
  - 漫画服务 src/services/comic.ts（Gemini 模型、8 格信息图结构）
  - Tushare 封装 src/services/tushare.ts（含 proxy、Mock 降级、缓存 TTL）

---

## 一、概念层面：为什么做这个产品

### 1.1 产品初衷

核心洞察：财报是投资决策的“黄金信息源”，但大多数散户缺乏时间与专业能力完成系统解读。Finspark 用 AI 将机构级财报分析“翻译成人话”，并以信息图和漫画方式降低理解门槛。

### 1.2 目标用户与痛点

- 目标用户：具备一定投资经验、每周可投入 1–3 小时研究的散户投资者
- 核心痛点：
  - 看不懂：长篇财报、术语密集、要点难抓
  - 不会做：指标不会算、缺对比/趋势、难识别风险
  - 没时间：关注标的多、窗口期短、信息过载

### 1.3 价值对比（传统 vs Finspark）

- 5 分钟出结构化报告（涵盖三表、风险、估值与趋势）
- 0 门槛理解关键指标，配合可视化与漫画降低认知成本
- 支持行业对比、估值评估与趋势解读，辅助投资判断

---

## 二、实现层面：我们如何实现

### 2.1 分层架构（与代码一致）

- 数据层：
  - Tushare 主数据源（支持 5000 积分中转站）；D1 持久化，KV 缓存
  - 失败降级：Mock 数据回退（src/services/tushare.ts）
- 分析层（核心编排器）：
  - Orchestrator 负责 DAG 混合编排与进度回调（src/agents/orchestrator.ts）
- 输出层：
  - 报告 HTML/PDF 与信息图漫画（src/services/pdf.ts、src/services/comic.ts）

### 2.2 核心分析流水线：10 个前台 Agent + 2 个结果增强模块

前台 10 个（前端显示执行进度的卡片）：
1) 分析规划（PLANNING）
2) 利润表分析（PROFITABILITY）
3) 资产负债表分析（BALANCE_SHEET）
4) 现金流量表分析（CASH_FLOW）
5) 三表联动/盈利质量（EARNINGS_QUALITY）
6) 风险评估（RISK）
7) 业务洞察（BUSINESS_INSIGHT）
8) 商业模式（BUSINESS_MODEL，按需）
9) 业绩预测（FORECAST，按需）
10) 最终结论（FINAL_CONCLUSION）

结果增强（不在前端进度卡片中，但在结果页展示）：
- 估值评估（VALUATION）：基于 daily_basic + fina_indicator，生成相对与内在估值结论
- 趋势解读（TREND_INTERPRETATION）：针对 8 个核心指标输出趋势洞察（含行业基准）

说明：
- 行业对比（INDUSTRY_COMPARISON）为独立能力，不在上述 10 个前台执行卡片中；通过单独 API 拉取并渲染行业面板。

### 2.3 行业对比模块（新增，独立 API）

- 能力定位：横向同业对标，输出行业地位与关键指标排名/对比
- 数据路径：D1 中已同步的对标公司财务数据（必要时触发同步）
- 核心接口：
  - 获取对标公司：GET /api/stock/industry-peers/:code
  - 同步对标公司数据：POST /api/stock/sync-industry-peers/:code
  - 获取行业对比数据：GET /api/stock/industry-comparison/:code
  - AI 深度对比结论：GET /api/analyze/industry-comparison/:code（含缓存）
- 前端：index.tsx 中的 industryComparisonCard 完整展示（表格、柱状图、雷达图、AI 分析）

### 2.4 模型与提示词策略（落地）

- 分析主模型：GPT-4.1（VectorEngine 封装，温度低、长上下文）
- 漫画：
  - 脚本：Gemini（gemini-3-pro-preview / 2.5-flash）
  - 图片：Gemini（gemini-3-pro-image-preview），采用结构化信息图提示词
- 行业对比/趋势解读：使用专用 Prompt（见 src/agents/prompts.ts）并统一 JSON 输出约束

### 2.5 数据来源与缓存策略

- 主来源：Tushare（支持官方与中转站），接口频控 + KV 缓存（分钟/小时级）
- 本地持久化：D1（stocks/financials/reports/comic_reports 等）
- 共享缓存：同一股票 24 小时分析结果共享（避免重复消耗）
- 降级：接口失败引入 Mock 数据（演示与高可用保障）

### 2.6 智能问数助手（Text-to-SQL）

- 定位：独立于主编排的“问数模块/Agent”，基于 D1 的结构化财务数据与本地分析结果摘要；不占用前台 10 个进度卡片。
- 用户价值：在阅读分析报告之外，用户可随时提出“数据问题”，即时获得“表格事实 + 自然语言解读”。
- 典型问题：
  - “近8个季度营收、净利润、毛利率的同比/环比走势？”
  - “自由现金流为负的季度有哪些？对应经营/投资现金流分别是多少？”
  - “毛利率显著低于行业均值的季度列表（标注具体差值）。”
- 用户入口：
  - 悬浮助手：分析页右下角“问数”悬浮球，侧边栏对话。
  - 卡片内按钮：“问这个指标”，自动带入上下文（股票、报告期、指标）。
  - 全屏页：/assistant 适合复杂问题与导出。
- 功能清单：
  - 自然语言→SQL 生成（只读），参数化绑定与表名/列名白名单校验。
  - 安全网：只允许 SELECT；强制 LIMIT（默认 200，登录后可提升）；禁用 DROP/UPDATE/DELETE/INSERT/ALTER；时间/数字参数校验；并发与行数限流。
  - 结果呈现：表格（支持 CSV 导出）+ AI 解读（引用关键数字与数据来源 dataSource）。
  - 上下文：自动携带股票、行业基准、最近报告期；多轮追问沿用 session。
- 关键指标（运营侧）：SQL 生成成功率≥95%，只读校验通过率≥99%，完整答案 P90≤8s，用户满意度≥4.3/5.0。
- 路线图：短期加入自动图表（折线/柱状）与“收藏问题”；中期接入 RAG（财报原文/公告）；长期支持跨公司多表 JOIN 模板化。

---

## 三、关键难点与解法

- 高质量数据获取：采用 Tushare + 中转站 + 本地缓存 + Mock 降级
- 分析稳定性：统一 JSON 输出模板 + 解析兜底（代码层多重 JSON 提取）
- 成本控制：
  - 共享缓存 24 小时  
  - 趋势解读与行业对比做中长期缓存（90 天/7 天）
  - 估值评估按近 30 日均值等做本地轻量计算
- 前端体验：
  - 分层展示（摘要 → 深度 → 折叠）
  - 行业对比独立面板，按需加载

---

## 四、体验与效果评估

- 用户体验（定性）：任务完成率、操作步数、速度与满意度跟踪（前端埋点 + 日志）
- 数据效果（定量）：
  - 报告完整阅读率、功能使用深度、留存/转化等指标
  - AI 输出结构化完整率、JSON 解析成功率（>99% 目标）
- 模型评测：保留多模型路由与评估能力（src/services/modelRouter.ts），但当前生产默认 GPT-4.1

---

## 五、产品路线（校准）

- Q1（MVP 已上线）：核心三表分析 + 风险/商业模式/预测 + 估值 + 趋势解读 + 行业对比面板 + 漫画
- Q2：
  - 智能问数增强（RAG for 财报原文）
  - 历史数据回溯与更完善的本地持久化
- Q3：
  - 高级估值（DCF/相对估值完善）
  - 财务预警（异常检测）
  - 用户体系（登录/自选/历史报告）
- Q4：
  - 商业化：会员 + 高级功能
  - 多端覆盖：移动端/小程序/插件

---

## 六、与 v2.0 文档的差异更正清单

1) Agent 数量与归属：
   - 旧稿：12 个 Agent（含数据采集/清洗、行业对比、报告生成）
   - 现状：前台 10 个执行 Agent（进度可见）+ 2 个结果增强（估值/趋势），行业对比独立模块，数据采集/清洗与报告生成归类为服务/输出层

2) 模型策略：
   - 旧稿：漫画脚本使用 GPT-4.1
   - 现状：漫画脚本/图片采用 Gemini（已在 comic.ts 明确）

3) 行业对比：
   - 旧稿：写为主流水线的一个 Agent
   - 现状：独立 API/面板，支持对标公司同步、指标排名与 AI 总结（见 /api/analyze/industry-comparison/:code）

4) 估值评估与趋势解读：
   - 旧稿：未强调“结果增强”定位
   - 现状：已落地并在报告中展示，但不在进度卡片列表中单列

---

## 七、用户指引（当前入口）

- 搜索页：输入股票代码或名称 → 命中缓存则秒开，否则 1–2 分钟生成
- 分析页：
  - 顶部“投资建议摘要”与核心指标卡片
  - 财报三表模块与三表联动（盈利质量）
  - 风险评估、业绩预测、估值评估、趋势解读
  - 行业对比面板（表格 + 柱状图 + 雷达图 + AI 结论）
  - 智能问数助手：
    - 右下角“问数”悬浮球 → 侧边栏对话
    - 各模块“问这个指标”→ 自动带入上下文
    - 结果支持 CSV 导出/复制 SQL
  - PDF 导出、漫画解读（IP 角色配置，支持长图）

---

## 八、总结

- 定位清晰：把机构级分析方法论“翻译成人话”，用可视化和漫画降低门槛
- 工程落地：以 Orchestrator + 服务层/缓存为核心的可运营化架构
- 持续迭代：在保持成本与稳定性的前提下，不断提升分析深度与交互质量

—— 产品团队（已与研发完成代码一致性自查）
